{{- /* Get configuration. */}}
{{- $startLevel := or (.Site.Params.navigation.startLevel | int) 2 }}
{{- $endLevel := or (.Site.Params.navigation.endLevel | int) 3 }}
{{- $minNumHeadings := or (.Site.Params.navigation.minNumHeadings | int) 2 }}

{{- /* Initialize. */}}
{{- $headingsAll := partial "assets/toc-headings.html" . }}

{{- /* Filter by configured levels. */}}
{{- $headings := slice }}
{{- range $headingsAll }}
  {{- if and (ge .level $startLevel) (le .level $endLevel) }}
    {{- $headings = $headings | append . }}
  {{- end }}
{{- end }}

{{- /* Build edit URL */}}
{{- $repo   := .Site.Params.github.repo }}
{{- $branch := .Site.Params.github.branch | default "main" }}
{{- $editURL := "" }}
{{- with .File }}
  {{- $filePath := replace .Path "\\" "/" }}
  {{- $editURL = printf "%s/edit/%s/content/%s" $repo $branch $filePath }}
{{- end }}

{{- /* Render */}}
{{- if .Site.Params.navigation.toc }}
  {{- if ge (len $headings) $minNumHeadings }}
    <strong class="d-block h6 my-2 pt-4">{{ T "toc" }}:</strong>
    <nav class="toc">
      {{- range $headings }}
        {{- $attrs := dict "class" (printf "toc-item toc-level-%d" (add 1 (sub .level $startLevel))) }}
        {{- with .id }}
          {{- $attrs = merge $attrs (dict "href" (printf "%s#%s" $.RelPermalink .)) }}
        {{- end }}
        <a{{- range $k, $v := $attrs }}{{ printf " %s=%q" $k $v | safeHTMLAttr }}{{- end -}}>{{ .text }}</a>
      {{- end }}
    </nav>
  {{- end }}

  {{- if $editURL }}
    <hr class="my-3" style="opacity: 0.25;">
    <div class="mt-2">
      <a href="{{ $editURL }}"
         target="_blank"
         rel="noopener"
         class="toc-item"
         style="font-size: 0.875rem;">
        {{ T "edit-page" }}
      </a>
    </div>
  {{- end }}
{{- end }}
<!-- 
{{/* DEBUG */}}
{{- if true }}
  <hr class="my-3" style="opacity: 0.25;">
  <div class="toc-item" style="font-size: 0.75rem; opacity: 0.85; line-height: 1.35;">
    <strong>TOC Debug</strong><br>

    <div><strong>Page</strong>: {{ .Title }}</div>
    <div><strong>Kind</strong>: {{ .Kind }}</div>
    <div><strong>Type</strong>: {{ .Type }}</div>
    <div><strong>RelPermalink</strong>: {{ .RelPermalink }}</div>

    <div><strong>Has .File</strong>: {{ with .File }}yes{{ else }}no{{ end }}</div>
    {{ with .File }}
      <div><strong>.File.Path</strong>: {{ .Path }}</div>
      <div><strong>.File.Dir</strong>: {{ .Dir }}</div>
      <div><strong>.File.LogicalName</strong>: {{ .LogicalName }}</div>
      <div><strong>.File.TranslationBaseName</strong>: {{ .TranslationBaseName }}</div>
    {{ end }}

    <div><strong>Params.navigation.toc</strong>: {{ .Site.Params.navigation.toc }}</div>
    <div><strong>Params.navigation.startLevel</strong>: {{ .Site.Params.navigation.startLevel }}</div>
    <div><strong>Params.navigation.endLevel</strong>: {{ .Site.Params.navigation.endLevel }}</div>
    <div><strong>Params.navigation.minNumHeadings</strong>: {{ .Site.Params.navigation.minNumHeadings }}</div>

    {{- $repo := .Site.Params.github.repo }}
    {{- $branch := .Site.Params.github.branch | default "main" }}
    <div><strong>github.repo</strong>: {{ $repo }}</div>
    <div><strong>github.branch</strong>: {{ $branch }}</div>

    {{- $editURL := "" }}
    {{- with .File }}
      {{- $filePath := replace .Path "\\" "/" }}
      {{- $editURL = printf "%s/edit/%s/content/%s" $repo $branch $filePath }}
    {{- end }}
    <div><strong>Edit URL</strong>: {{ if $editURL }}<a href="{{ $editURL }}" target="_blank" rel="noopener">{{ $editURL }}</a>{{ else }}(empty){{ end }}</div>

    {{- $h := partial "assets/toc-headings.html" . }}
    <div><strong>Raw headings count</strong>: {{ len $h }}</div>
  </div>
{{- end }}
 -->
