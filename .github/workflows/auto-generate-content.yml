name: Convert News/Event Issue to Markdown

on:
  issues:
    types: [opened]

jobs:
  generate-post:
    if: contains(join(github.event.issue.labels.*.name, ','), 'automation')
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Extract issue data and generate markdown
        run: |
          mkdir -p temp-posts
          echo "${{ github.event.issue.body }}" > issue-body.md

          python3 <<EOF
          import re
          import os
          import sys

          with open("issue-body.md", encoding="utf-8") as f:
              body = f.read()

          def extract_field(label):
              match = re.search(rf"### {label}\\s+(.+?)(?=(\\n###|$))", body, re.DOTALL)
              return match.group(1).strip() if match else ""

          title = extract_field("Title")
          content = extract_field("Content") or extract_field("Description")
          date = extract_field("Date") or extract_field("Event Date")
          image = extract_field("Optional image markdown")
          kind = "news" if 'news' in "${{ github.event.issue.labels.*.name }}" else "events"
          
          slug = "-".join(title.lower().split())
          filename = f"content/{kind}/{date}-{slug}.md"

          os.makedirs(os.path.dirname(filename), exist_ok=True)

          with open(filename, "w", encoding="utf-8") as f:
              f.write(f"---\\ntitle: \\"{title}\\"\\ndate: {date}\\n---\\n\\n")
              if image:
                  f.write(image + "\\n\\n")
              f.write(content.strip())
          EOF

      - name: Commit and create pull request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "Add post from issue #${{ github.event.issue.number }}"
          branch: "auto/post-${{ github.event.issue.number }}"
          title: "Auto post from issue #${{ github.event.issue.number }}"
