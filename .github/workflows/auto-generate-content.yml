name: Convert News/Event Issue to Markdown

on:
  issues:
    types: [opened]

jobs:
  generate-post:
    if: contains(join(github.event.issue.labels.*.name, ','), 'automation')
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Extract issue data and generate markdown
        run: |
          mkdir -p temp-posts
          echo "${{ github.event.issue.body }}" > issue-body.md

          python3 <<EOF
          import re
          import os
          import unicodedata
          import json
          from datetime import datetime

          with open("issue-body.md", encoding="utf-8") as f:
              body = f.read()

          def extract_field(label):
              match = re.search(rf"### {label}\\s+(.+?)(?=(\\n###|$))", body, re.DOTALL)
              return match.group(1).strip() if match else ""

          def slugify(text):
              text = unicodedata.normalize('NFKD', text).encode('ascii', 'ignore').decode('ascii')
              return re.sub(r'[^a-z0-9]+', '-', text.lower()).strip('-')

          # Load label names from GitHub Action context
          labels_raw = """${{ toJson(github.event.issue.labels) }}"""
          label_names = [label["name"].lower() for label in json.loads(labels_raw)]

          is_event = 'event' in label_names
          is_news = 'news' in label_names

          if is_event:
              title = extract_field("Title")
              name = extract_field("Event Name")
              dt_raw = extract_field("Start Date and Time")
              dt = datetime.fromisoformat(dt_raw).isoformat()
              duration = extract_field("Duration")
              location = extract_field("Location")
              content = extract_field("Description (EN)")
              image = extract_field("Poster or Cover Image")

              slug = slugify(name or title)
              folder = f"content/events/{dt_raw.lower().replace(':', '-')}-{slug}"
              os.makedirs(folder, exist_ok=True)
              filename = f"{folder}/index.en.md"

              with open(filename, "w", encoding="utf-8") as f:
                  f.write("---\n")
                  f.write(f"type: phd-thesis-defense\n")
                  f.write(f'title: "{title}"\n')
                  f.write(f'name: {name}\n')
                  f.write(f'datetime: {dt}\n')
                  f.write(f'duration: {duration}\n')
                  f.write(f'location: {location}\n')
                  f.write("---\n\n")
                  if image:
                      f.write(image + "\n\n")
                  f.write(content.strip() + "\n")

          elif is_news:
              title = extract_field("Title")
              date = extract_field("Date")
              content = extract_field("Description (EN)")
              image = extract_field("Thumbnail Image")

              slug = slugify(title)
              folder = f"content/news/{date}-news-{slug}"
              os.makedirs(folder, exist_ok=True)
              filename = f"{folder}/index.en.md"

              with open(filename, "w", encoding="utf-8") as f:
                  f.write("---\n")
                  f.write(f"type: news\n")
                  f.write(f'title: "{title}"\n')
                  f.write(f'description: {title}\n')
                  f.write(f"featured: false\n")
                  f.write(f"date: {date}\n")
                  if image:
                      image_line = re.search(r'!\[.*?\]\((.*?)\)', image)
                      if image_line:
                          image_path = image_line.group(1)
                          f.write(f"thumbnail: {image_path}\n")
                  f.write("---\n\n")
                  f.write(content.strip() + "\n")
          else:
              print("Could not detect type from labels.")
              exit(1)

          print("âœ… File created:", filename)
          EOF

      - name: Commit and create pull request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "Add post from issue #${{ github.event.issue.number }}"
          branch: "auto/post-${{ github.event.issue.number }}"
          title: "Auto post from issue #${{ github.event.issue.number }}"

